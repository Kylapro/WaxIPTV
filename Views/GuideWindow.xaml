<Window x:Class="WaxIPTV.Views.GuideWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="EPG Guide"
        Height="600" Width="1000"
        MinHeight="400" MinWidth="600"
        Background="{DynamicResource BgBrush}"
        Foreground="{DynamicResource TextBrush}"
        Icon="pack://application:,,,/WaxIPTVIcon.ico">
    <!--
        The EPG guide window displays a timeline of programmes for all channels
        in the current playlist.  A filter bar along the top allows the
        user to narrow the channel list by group and search term.  Each
        row shows a channel icon and name on the left and its scheduled
        programmes across a fixed time range on the right.  The timeline
        scrolls horizontally while the channel names remain fixed.  When
        a programme block is clicked, the parent window can start
        playback of the associated channel via the ChannelSelected event.
    -->
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="200"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- EPG loading indicator and filter bar -->
        <Grid Grid.Row="0" Grid.ColumnSpan="2" Margin="0,0,0,8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <!-- EPG loading panel for the guide.  Displays a progress bar and
                 message while guide rows are being constructed.  Hidden by
                 default and toggled in code-behind. -->
            <StackPanel x:Name="GuideEpgLoadingPanel"
                        Grid.Row="0"
                        Orientation="Horizontal"
                        Visibility="Collapsed"
                        Margin="0,0,0,4">
                <TextBlock x:Name="GuideLoadingLabel"
                           Text="Loading EPG..."
                           VerticalAlignment="Center"
                           Margin="0,0,8,0"/>
                <ProgressBar x:Name="GuideProgressBar"
                             Height="4"
                             Width="200"
                             VerticalAlignment="Center"/>
            </StackPanel>
            <!-- Filter bar across both columns -->
            <DockPanel Grid.Row="1">
                <!-- Group filter on the left -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" Margin="0,0,8,0">
                    <TextBlock Text="Group" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <ComboBox x:Name="GroupFilter" Width="160"
                              SelectionChanged="GroupFilter_SelectionChanged"
                              Background="{DynamicResource DropdownBrush}"
                              Foreground="{DynamicResource TextBrush}"
                              BorderBrush="{DynamicResource DividerBrush}"
                              BorderThickness="1"/>
                </StackPanel>
                <!-- Clear button on the right -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" Margin="8,0,0,0">
                    <Button Content="Clear"
                            Click="ClearSearch_Click"
                            Style="{DynamicResource AccentButton}"/>
                </StackPanel>
                <!-- Search box fills remaining space -->
                <TextBox x:Name="SearchBox"
                         Margin="0,0,8,0"
                         VerticalAlignment="Center"
                         HorizontalAlignment="Stretch"
                         TextChanged="SearchBox_TextChanged"
                         Background="{DynamicResource SurfaceBrush}"
                         Foreground="{DynamicResource TextBrush}"
                         BorderBrush="{DynamicResource DividerBrush}"
                         BorderThickness="1"/>
            </DockPanel>
        </Grid>

        <!-- Channel names list -->
        <ListBox x:Name="ChannelNamesList" Grid.Row="1" Grid.Column="0"
                 BorderThickness="0"
                 Background="{DynamicResource BgBrush}"
                 Foreground="{DynamicResource TextBrush}"
                 SelectionChanged="ChannelNamesList_SelectionChanged"
                 ScrollViewer.VerticalScrollBarVisibility="Hidden"
                 ScrollViewer.CanContentScroll="True"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <!-- Clicking anywhere in a channel row will select and play the channel.  
                         The MouseLeftButtonUp event is handled in the code-behind to 
                         raise the ChannelSelected event. -->
                    <StackPanel Orientation="Horizontal" Margin="0,2" Height="40"
                                MouseLeftButtonUp="ChannelRow_Click">
                        <Image Source="{Binding ChannelIcon}" Width="32" Height="32" Margin="0,0,6,0"/>
                        <TextBlock Text="{Binding ChannelName}" VerticalAlignment="Center"/>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Timeline area -->
        <ScrollViewer x:Name="TimelineScrollViewer"
                      Grid.Row="1" Grid.Column="1"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      ScrollChanged="TimelineScrollViewer_ScrollChanged">
            <StackPanel>
                <!-- Timeline header: draws time labels across the timeline -->
                <Canvas x:Name="TimelineHeaderCanvas" Height="30" Background="{DynamicResource SurfaceBrush}"/>
                <!-- Timeline rows: one per channel; virtualization enabled for better performance -->
                <ItemsControl x:Name="TimelineItemsControl"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              ScrollViewer.CanContentScroll="True">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- Each row consists of a canvas containing programme blocks -->
                            <Canvas Height="40" Background="{DynamicResource SurfaceBrush}">
                                <ItemsControl ItemsSource="{Binding ProgrammeSlots}"
                                              VirtualizingPanel.IsVirtualizing="True"
                                              VirtualizingPanel.VirtualizationMode="Recycling"
                                              ScrollViewer.CanContentScroll="True">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style TargetType="ContentPresenter">
                                            <Setter Property="Canvas.Left" Value="{Binding Offset}"/>
                                            <Setter Property="Canvas.Width" Value="{Binding Width}"/>
                                            <Setter Property="Canvas.Top" Value="4"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="{DynamicResource AccentBrush}"
                                                    BorderBrush="{DynamicResource AccentBrush}"
                                                    BorderThickness="1"
                                                    CornerRadius="4"
                                                    ToolTip="{Binding ToolTip}"
                                                    MouseLeftButtonUp="ProgrammeSlot_Click"
                                                    ClipToBounds="True">
                                                <TextBlock Text="{Binding DisplayTitle}"
                                                           Foreground="{DynamicResource TextBrush}"
                                                           FontSize="12"
                                                           Padding="4,2"
                                                           TextTrimming="CharacterEllipsis"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Canvas>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</Window>