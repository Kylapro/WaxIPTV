<UserControl x:Class="WaxIPTV.EpgGuide.GuideView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:WaxIPTV.EpgGuide"
             Focusable="True" PreviewKeyDown="OnPreviewKeyDown">
  <UserControl.Resources>
    <local:TimeToXConverter x:Key="TimeToX"/>
    <local:DurationToWidthConverter x:Key="TimeToW"/>
    <local:VisibleProgramsConverter x:Key="VisiblePrograms"/>
    <Style x:Key="ProgramCell" TargetType="Button">
      <Setter Property="Padding" Value="{DynamicResource SpacingS}"/>
      <Setter Property="BorderThickness" Value="0"/>
      <Setter Property="HorizontalContentAlignment" Value="Left"/>
      <Setter Property="VerticalContentAlignment" Value="Center"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Button">
            <Border Background="{DynamicResource AccentSelectionBrush}"
                    CornerRadius="{DynamicResource ThemeCornerRadius}"
                    ClipToBounds="True">
              <TextBlock Text="{TemplateBinding Content}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
            </Border>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>
  </UserControl.Resources>

  <Grid Background="{DynamicResource BgBrush}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/> <!-- Search & filters -->
      <RowDefinition Height="Auto"/> <!-- Info panel -->
      <RowDefinition Height="Auto"/> <!-- Headers -->
      <RowDefinition Height="*"/>     <!-- Grid -->
    </Grid.RowDefinitions>
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="220"/>
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>

    <!-- Search and group filter -->
    <StackPanel Grid.Row="0" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="8,4">
      <TextBox Width="200" Margin="0,0,8,0"
               Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
      <ComboBox Width="150" ItemsSource="{Binding Groups}" SelectedItem="{Binding SelectedGroup}"/>
    </StackPanel>

    <!-- Info panel -->
    <Border Grid.Row="1" Grid.ColumnSpan="2" Background="{DynamicResource SurfaceBrush}" Padding="12" BorderBrush="{DynamicResource DividerBrush}" BorderThickness="0,0,0,1">
      <StackPanel>
        <TextBlock Text="{Binding SelectedProgram.Title}" FontSize="18" FontWeight="Bold"/>
        <TextBlock Text="{Binding SelectedProgram.StartUtc, StringFormat='{}{0:HH:mm} UTC'}" Opacity="0.7"/>
        <TextBlock Text="{Binding SelectedProgram.Synopsis}" Opacity="0.8" TextTrimming="WordEllipsis"/>
      </StackPanel>
    </Border>

    <!-- Channel header -->
    <Border Grid.Row="2" Grid.Column="0" Background="{DynamicResource SurfaceBrush}" BorderBrush="{DynamicResource DividerBrush}" BorderThickness="0,0,1,1">
      <TextBlock Text="Channel" Padding="10,6" FontWeight="Bold"/>
    </Border>

    <!-- Hour strip (header) -->
    <ScrollViewer x:Name="TimelineScroller" Grid.Row="2" Grid.Column="1" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled" ScrollChanged="OnTimelineScrollChanged">
      <ItemsControl x:Name="HourStrip">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate><StackPanel Orientation="Horizontal"/></ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
      </ItemsControl>
    </ScrollViewer>

    <!-- Channels column -->
    <ScrollViewer x:Name="ChannelsScroller" Grid.Row="3" Grid.Column="0" VerticalScrollBarVisibility="Auto"
                  CanContentScroll="True" ScrollChanged="OnChannelsScrollChanged">
      <ItemsControl ItemsSource="{Binding FilteredChannels}"
                    VirtualizingStackPanel.IsVirtualizing="True"
                    VirtualizingStackPanel.VirtualizationMode="Recycling">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate><VirtualizingStackPanel/></ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.ItemTemplate>
          <DataTemplate DataType="{x:Type local:ChannelRow}">
            <Grid Height="56">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="40"/>
                <ColumnDefinition Width="*"/>
              </Grid.ColumnDefinitions>
              <TextBlock Text="{Binding Number}" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,8,0" Opacity="0.8"/>
              <TextBlock Grid.Column="1" Text="{Binding Name}" FontWeight="SemiBold" VerticalAlignment="Center"/>
            </Grid>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>

    <!-- Program grid -->
    <ScrollViewer x:Name="GridScroller" Grid.Row="3" Grid.Column="1"
                  HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                  ScrollChanged="OnGridScrollChanged"
                  CanContentScroll="True">
      <ItemsControl ItemsSource="{Binding FilteredChannels}"
                    VirtualizingStackPanel.IsVirtualizing="True"
                    VirtualizingStackPanel.VirtualizationMode="Recycling">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate><VirtualizingStackPanel/></ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.ItemTemplate>
          <DataTemplate DataType="{x:Type local:ChannelRow}">
            <Grid Height="56" Background="{DynamicResource SurfaceBrush}">
              <ItemsControl Width="{Binding DataContext.TimelinePixelWidth, RelativeSource={RelativeSource AncestorType=UserControl}}" ClipToBounds="True">
                <ItemsControl.ItemsSource>
                  <MultiBinding Converter="{StaticResource VisiblePrograms}">
                    <Binding Path="Programs"/>
                    <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.VisibleStartUtc"/>
                    <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.VisibleEndUtc"/>
                  </MultiBinding>
                </ItemsControl.ItemsSource>
                <ItemsControl.ItemsPanel>
                  <ItemsPanelTemplate>
                    <Canvas Width="{Binding DataContext.TimelinePixelWidth, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                  </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                  <Style TargetType="ContentPresenter">
                    <Setter Property="Canvas.Left">
                      <Setter.Value>
                        <MultiBinding Converter="{StaticResource TimeToX}">
                          <Binding Path="StartUtc"/>
                          <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.VisibleStartUtc"/>
                          <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.PxPerMinute"/>
                        </MultiBinding>
                      </Setter.Value>
                    </Setter>
                    <Setter Property="Width">
                      <Setter.Value>
                        <MultiBinding Converter="{StaticResource TimeToW}">
                          <Binding Path="StartUtc"/><Binding Path="EndUtc"/>
                          <Binding RelativeSource="{RelativeSource AncestorType=UserControl}" Path="DataContext.PxPerMinute"/>
                        </MultiBinding>
                      </Setter.Value>
                    </Setter>
                    <Setter Property="Height" Value="48"/>
                    <Setter Property="Margin" Value="2,4,2,4"/>
                  </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                  <DataTemplate DataType="{x:Type local:ProgramBlock}">
                    <Button Style="{StaticResource ProgramCell}"
                            Content="{Binding Title}"
                            CommandParameter="{Binding}"
                            Click="OnProgramClicked"/>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </Grid>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </ScrollViewer>
  </Grid>
</UserControl>
